/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("travel.request.create.util.Formatters");jQuery.sap.require("travel.request.create.util.InputHelper");jQuery.sap.require("sap.ca.ui.dialog.factory");jQuery.sap.require("sap.m.MessageBox");sap.ca.scfld.md.controller.BaseDetailController.extend("travel.request.create.view.DetailForm",{onInit:function(){this.oResourceBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this.viewModes={"NewTravel":1,"EditTravel":2};var t=this;var v=this.getView();this.setHeaderFooterOptions(this.createHeaderFooterOptions());this.oRouter.attachRouteMatched(function(e){var p=this.byId("TRC_NEW_PAGE");p.scrollTo(0);var c=new sap.ui.model.Context(v.getModel(),"/"+e.getParameter("arguments").contextPath);if(e.getParameter("name")==="new"){p.setTitle(t.oResourceBundle.getText("TRC_NEW_PAGE"));t.viewMode=t.viewModes.NewTravel;this.callValueHelps(t.viewMode);this.createEmptyRequestModel()}if(e.getParameter("name")==="edit"){this.getView().bindElement(c.sPath);this.getView().getModel().updateBindings(true);p.setTitle(t.oResourceBundle.getText("TRC_EDIT_PAGE"));t.viewMode=t.viewModes.EditTravel;t.detailContextPath=c.sPath;this.callValueHelps(t.viewMode,c.sPath);this.createEmptyRequestModel();this.resetControlState()}if(e.getParameter("name")==="edit"||e.getParameter("name")==="new"){this.oDataModel.resetChanges();this.buffer=new sap.ui.model.json.JSONModel({validatedCountryCode:"",countryHasRegions:false});var f=this.byId("MB_FORM_COUNTRY");var F=this.byId("MB_FORM_PER_DIEM_REGION");var o=this.byId("MB_FORM_DESTINATION");var w=this.isPerDiemRegionsEnabled();if(f){f.setVisible(w)}if(F){F.setVisible(w)}if(o){o.setVisible(!w)}if(w){if(e.getParameter("name")==="edit"){var C=this.byId("Trc_SD_Country");var s=this.getCodeFromFormattedValue(C.getValue());this.handlePerDiemRegionVisibility(s,false)}else{F.setVisible(false)}}}},this)},isPerDiemRegionsEnabled:function(){var m=this.oApplicationFacade.getODataModel();var r=m.oMetadata._getEntityTypeName("Regions");return(r!==undefined)},callValueHelps:function(v,c){var b=[];var B;var t=this;var m=this.getView().getModel();m.clearBatch();B=m.createBatchOperation("Countries","GET");b.push(B);B=m.createBatchOperation("Currencies","GET");b.push(B);B=m.createBatchOperation("TripActivities","GET");b.push(B);B=m.createBatchOperation("UserInfo","GET");b.push(B);if(v===this.viewModes.EditTravel){B=m.createBatchOperation(c+"/CostAssignments","GET");b.push(B)}m.addBatchReadOperations(b);this._setBusyOn();m.submitBatch(function(d,r,e){t.createModels(d,v);if(v===t.viewModes.NewTravel){t.intiateCostAssignments();t.cleanUpForm()}else{t.createCostAssignmentsModel()}},function(e){t._onRequestFailed(e)},true)},createModels:function(d,v){var t=this;d=JSON.parse(JSON.stringify(d));var b=d.__batchResponses;var D=null;if(b[0]){D=b[0].data;var o=new sap.ui.model.json.JSONModel(D);o.setSizeLimit(500);this.getView().setModel(o,"Destination")}var C=null;if(b[1]){C=b[1].data;var c=new sap.ui.model.json.JSONModel(C);c.setSizeLimit(500);this.getView().setModel(c,"Currencies")}var T=null;if(b[2]){T=b[2].data;var a=new sap.ui.model.json.JSONModel(T);a.setSizeLimit(500);this.getView().setModel(a,"TripActivities")}var U=null;if(b[3]){U=b[3].data;var u=new sap.ui.model.json.JSONModel(U);u.setSizeLimit(500);this.getView().setModel(u,"UserInfo");this.updateModelWithCostCenterTypes()}if(v===this.viewModes.EditTravel){var e=null;if(b[4]){e=b[4].data;var f=new sap.ui.model.json.JSONModel(e);f.setSizeLimit(500);this.getView().setModel(f,"CostAssignments")}}t._setBusyOff()},createEmptyRequestModel:function(){this.CreateTravelRequestModel=new sap.ui.model.json.JSONModel({"Purpose":"","TripActivity":"","Departure":"","Arrival":"","CountryCode":"","RegionCode":"","Location":"","EstimatedCost":{Value:'',Currency:''},"Note":""})},cleanUpForm:function(){var c=travel.request.create.util.Formatters.getTodayDate();var t=new Date();this.byId("Trc_I_Purpose").setValue("");this.byId("Trc_s_Activity").setSelectedKey("");this.byId("Trc_D_From").setValue(c);this.byId("Trc_D_From").setDateValue(t);this.byId("Trc_D_To").setValue(c);this.byId("Trc_D_To").setDateValue(t);this.byId("Trc_SD_Destination").setValue("");this.byId("Trc_SD_Country").setValue("");this.byId("Trc_SD_PerDiemRegion").setValue("");this.byId("Trc_E_City").setValue("");this.byId("Trc_E_Cost").setValue("");if(!this.checkGlobalSettingsFixedCurrency()){var u=this.getUserInfo();this.byId("Trc_SC_Currency").setValue(u.Currency)}else{this.byId("Trc_SC_Currency").setValue("")}this.byId("Trc_L_Note").setValue("");this.resetControlState()},resetControlState:function(){this.byId("Trc_I_Purpose").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_D_From").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_D_To").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_SD_Destination").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_SD_Country").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_SD_PerDiemRegion").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_E_City").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_E_Cost").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_SC_Currency").setValueState(sap.ui.core.ValueState.None);this.byId("Trc_L_Note").setValueState(sap.ui.core.ValueState.None)},createModel:function(m,p){var M=new sap.ui.model.json.JSONModel();var o=function(d,r){M.setData(d)};M.setSizeLimit(500);this.getView().setModel(M,m);this.oDataModel.read(p,null,null,true,jQuery.proxy(o,this),jQuery.proxy(this._onRequestFailed,this));return m},updateModelWithCostCenterTypes:function(){var t=[];var U=this.getUserInfo();var G;if(U.GlobalSettings){G=U.GlobalSettings}if(G){if(G.CostObjectNetwork){t.push({"name":this.oResourceBundle.getText("TRC_NETWORK"),"key":"Network"})}if(G.CostObjectNetworkActivity){t.push({"name":this.oResourceBundle.getText("TRC_NETWORK_ACTIVITY"),"key":"NetworkActivity"})}if(G.CostObjectProject){t.push({"name":this.oResourceBundle.getText("TRC_PROJECT"),"key":"Project"})}if(G.CostObjectCostCenter){t.push({"name":this.oResourceBundle.getText("TRC_COST_CENTER"),"key":"CostCenter"})}if(G.CostObjectInternalOrder){t.push({"name":this.oResourceBundle.getText("TRC_INTERNAL_ORDER"),"key":"InternalOrder"})}if(G.CostObjectSalesOrderItem){t.push({"name":this.oResourceBundle.getText("TRC_SALES_ORDER_ITEM"),"key":"SalesOrderItem"})}}else{t=[{"name":this.oResourceBundle.getText("TRC_COST_CENTER"),"key":"CostCenter"},{"name":this.oResourceBundle.getText("TRC_INTERNAL_ORDER"),"key":"InternalOrder"},{"name":this.oResourceBundle.getText("TRC_SALES_ORDER"),"key":"SalesOrder"}]}var m=new sap.ui.model.json.JSONModel(t);m.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.getView().setModel(m,"costObjects")},intiateCostAssignments:function(){var U=this.getUserInfo();var d;var a;d=U.CostCenter;a=U.CostCenterName;var C=[{"title":this.oResourceBundle.getText("TRC_LBL_COST_CENTER"),"counter":1,"percentage":100,"orderItemDisplayed":false,"selectedCostObject":d,"displaySelectedCostObjectField":false,"selectedCostObjectDesc":a+" ("+d+")","selectedCostObjectType":"CostCenter","removeDisplayed":false}];var m=new sap.ui.model.json.JSONModel(C);this.getView().setModel(m,"CostAssignmentsModel")},createCostAssignmentsModel:function(){if(this.getView().getModel("CostAssignments")!==undefined){var c=this.getView().getModel("CostAssignments").getData().results;var a=[];var i;for(i=0;i<c.length;i++){var b={};if(i===0){b.title=this.oResourceBundle.getText("TRC_LBL_COST_CENTER");b.removeDisplayed=false}b.Id=i;b.selectedCostObjectDesc=c[i].CostObjectName+" ("+c[i].CostObjectId+")";b.selectedCostObjectType=c[i].CostObjectType;b.selectedSalesOrderItem=c[i].CostObjectItemId;b.selectedSalesOrderItemDescription=c[i].CostObjectItemName;b.selectedCostObject=c[i].CostObjectId;b.percentage=c[i].Percentage;a.push(b);if(b.selectedCostObjectType=="SalesOrder"){this._soId=b.selectedCostObject;b.displaySelectedCostObjectField=true;b.orderItemDisplayed=false}else b.displaySelectedCostObjectField=false;b.supported=this.isCostCenterTypeSupported(b.selectedCostObjectType);b.showNotEditableField=!b.supported}var m=new sap.ui.model.json.JSONModel(a);this.getView().setModel(m,"CostAssignmentsModel")}},isCostCenterTypeSupported:function(c){var C=this.getView().getModel("costObjects").getData();for(var i=0;i<C.length;i++){if(c==C[i].key)return true}return false},clearPerDiemRegionFormField:function(){var f=this.byId("Trc_SD_PerDiemRegion");var c=this.getView().getBindingContext();if(f){f.setValueState(sap.ui.core.ValueState.None);this.oDataModel.setProperty("/Regions",[]);if(c){this.oDataModel.setProperty("RegionCode","",c);this.oDataModel.setProperty("RegionName","",c)}else{f.setValue("")}}},onDestinationValueHelpRequest:function(e){var o=["Id","Name"];this.onValueHelpRequest("Trc_SD_Destination","TRC_DESTINATION","/results","{Id}","{Name}","both",o,"Destination")},onDestinationSuggestionItemSelected:function(e){e.getSource().setValueState(sap.ui.core.ValueState.None)},onCountryValueHelpRequest:function(e){var o=["Id","Name"];this.onValueHelpRequest("Trc_SD_Country","TRC_COUNTRY","/results","{Id}","{Name}","both",o,"Destination",jQuery.proxy(this.handlePerDiemRegionVisibility,this))},onCountryChange:function(e){if(travel.request.create.util.InputHelper.validateValueHelpWithSuggestion(e)){var c=this.getCodeFromFormattedValue(e.getParameter("newValue"));this.handlePerDiemRegionVisibility(c,true)}else{var f=this.byId("MB_FORM_PER_DIEM_REGION");f.setVisible(false)}},onCountrySuggestionItemSelected:function(e){var f=this.byId("Trc_SD_Country");f.setValueState(sap.ui.core.ValueState.None)},onCountryLiveChange:function(e){if(e.getSource().getValue()===""){var f=this.byId("MB_FORM_PER_DIEM_REGION");f.setVisible(false)}},onPerDiemRegionLiveChange:function(e){if(e.getSource().getValue()===""){var f=this.byId("Trc_SD_PerDiemRegion");f.setValueState(sap.ui.core.ValueState.None)}},onPerDiemRegionChange:function(e){if(travel.request.create.util.InputHelper.validateValueHelpWithSuggestion(e)){var n=e.getParameter("newValue");var r=this.getCodeFromFormattedValue(n);var R=this.getDescriptionFromFormattedValue(n);var c=this.getView().getBindingContext();if(c){this.oDataModel.setProperty("RegionCode",r,c);this.oDataModel.setProperty("RegionName",R,c)}else{var f=this.byId("Trc_SD_PerDiemRegion");var F=travel.request.create.util.Formatters.formatNameWithId(R,r);f.setValue(F)}}},onPerDiemRegionSuggestionItemSelected:function(e){var f=this.byId("Trc_SD_PerDiemRegion");f.setValueState(sap.ui.core.ValueState.None)},getCodeFromFormattedValue:function(f){var c="";if(f&&f.length>0){c=f.substring(f.lastIndexOf(' (')+2,f.lastIndexOf(')'))}return c},getDescriptionFromFormattedValue:function(f){var d="";if(f&&f.length>0){d=f.substring(0,f.lastIndexOf(' ('))}return d},handlePerDiemRegionVisibility:function(c,f){if(c){var t=this;var F=this.byId("MB_FORM_PER_DIEM_REGION");if(c!==this.buffer.getProperty("/validatedCountryCode")){this.buffer.setProperty("/countryHasRegions",false);this.buffer.setProperty("/validatedCountryCode",c);this.oDataModel.read("Regions/$count",{context:null,urlParameters:"$filter="+jQuery.sap.encodeURL("CountryID"+" eq "+"'"+c+"'"),async:true,success:function(d,r){if(r&&parseInt(r.body,10)>0){t.buffer.setProperty("/countryHasRegions",true);F.setVisible(true);t.CreateTravelRequestModel.setProperty("/CountryCode",c);if(f){t.clearPerDiemRegionFormField()}}else{t.buffer.setProperty("countryHasRegions",false);F.setVisible(false)}}})}else{if(this.buffer.getProperty("/countryHasRegions")){F.setVisible(true)}}}},onPerDiemRegionValueHelpRequest:function(e){var t=this;var b;var c=this.byId("Trc_SD_Country");var p=this.byId("Trc_SD_PerDiemRegion");var C=c.getValueState();var s=this.getCodeFromFormattedValue(c.getValue());var f=[];var h=function(e){var S=e.getParameter("selectedItem");if(S){var r=S.getProperty("title");var R=S.getProperty("description");var o=t.getView().getBindingContext();if(p.getValueState()===sap.ui.core.ValueState.Error){if(o){t.oDataModel.setProperty("RegionCode","",o);t.oDataModel.setProperty("RegionName","",o)}else{p.setValue("")}}p.setValueState(sap.ui.core.ValueState.None);if(o){t.oDataModel.setProperty("RegionCode",r,o);t.oDataModel.setProperty("RegionName",R,o)}else{var F=travel.request.create.util.Formatters.formatNameWithId(R,r);p.setValue(F)}}};if(s&&C!==sap.ui.core.ValueState.Error){f.push(new sap.ui.model.Filter("CountryID",sap.ui.model.FilterOperator.EQ,s))}if(!this.oPerDiemRegionSelectDialog){this.oPerDiemRegionSelectDialog=new sap.m.SelectDialog({title:this.oResourceBundle.getText("TRC_PER_DIEM_REGION"),items:{path:"/Regions",template:new sap.m.StandardListItem({title:"{RegionID}",description:"{Description}",active:true}),filters:f},confirm:h,cancel:h})}else{b=this.oPerDiemRegionSelectDialog.getBindingInfo("items");this.oPerDiemRegionSelectDialog.bindAggregation("items",{path:b.path,template:b.template,filters:f,parameters:{custom:{search:""}}})}this.oPerDiemRegionSelectDialog.setModel(this.getView().getModel());this.oPerDiemRegionSelectDialog.open()},onPerDiemRegionSuggest:function(e){var b;var c=this.byId("Trc_SD_Country");var C=c.getValueState();var s=this.getCodeFromFormattedValue(c.getValue());var f=[];if(s&&C!==sap.ui.core.ValueState.Error){f.push(new sap.ui.model.Filter("CountryID",sap.ui.model.FilterOperator.EQ,s))}var n=e.getParameter("suggestValue")||"";b=e.getSource().getBindingInfo("suggestionItems");if(!b){e.getSource().bindAggregation("suggestionItems",{path:"/Regions",filters:f,startIndex:0,length:10,parameters:{custom:{search:n}},template:new sap.ui.core.Item({text:"{parts:[{path:'Description'},{path:'RegionID'}], formatter:'travel.request.create.util.Formatters.formatNameWithId'}"})})}else{e.getSource().bindAggregation("suggestionItems",{path:"/Regions",filters:f,startIndex:0,length:10,parameters:{custom:{search:n}},template:b.template})}},onCurrencyValueHelpRequest:function(e){var o=["Id","Name"];this.onValueHelpRequest("Trc_SC_Currency","TRC_CURRENCY","/results","{Id}","{Name}","single",o,"Currencies")},onCADescValueHelpRequest:function(e){var f;var c=e.getSource().getId();var C=c;c=c.replace("Trc_S_Type_Desc","Trc_S_Type");var a=this.getView().byId(c).getSelectedKey();if(a==="CostCenter"){f=["Id","Description"];if(this.getView().getModel("CostCenters")===undefined){this.createModel('CostCenters',"CostCenters")}this.onValueHelpRequest(C,"TRC_COST_CENTER","/results","{Id}","{Name}","both",f,"CostCenters")}if(a==="InternalOrder"){f=["Id","Name"];if(this.getView().getModel("InternalOrders")===undefined){this.createModel('InternalOrders',"InternalOrders")}this.onValueHelpRequest(C,"TRC_INTERNAL_ORDER","/results","{Id}","{Name}","Id",f,"InternalOrders")}if(a==="SalesOrder"){f=["Id","Name"];if(this.getView().getModel("SalesOrders")===undefined){this.createModel('SalesOrders',"SalesOrders")}this.onValueHelpRequest(C,"TRC_SALES_ORDER","/results","{Id}","{Name}","Id",f,"SalesOrders")}if(a==="Network"){f=["Id","Description"];if(this.getView().getModel("Network")===undefined){this.createModel('Network',"Network")}this.onValueHelpRequest(C,"TRC_NETWORK","/results","{Id}","{Name}","Id",f,"Network")}if(a==="NetworkActivity"){f=["Id","Description"];if(this.getView().getModel("NetworkActivity")===undefined){this.createModel('NetworkActivity',"NetworkActivity")}this.onValueHelpRequest(C,"TRC_NETWORK_ACTIVITY","/results","{Id}","{Name}","Id",f,"NetworkActivity")}if(a==="Project"){f=["Id","Description"];if(this.getView().getModel("Project")===undefined){this.createModel('Project',"Project")}this.onValueHelpRequest(C,"TRC_PROJECT","/results","{Id}","{Name}","Id",f,"Project")}if(a==="SalesOrderItem"){f=["Id","Description"];if(this.getView().getModel("SalesOrderItem")===undefined){this.createModel('SalesOrderItem',"SalesOrderItem")}this.onValueHelpRequest(C,"TRC_SALES_ORDER_ITEM","/results","{Id}","{Name}","Id",f,"SalesOrderItem")}},onOrderItemsValueHelpRequest:function(e){var t=this;var I=e.getSource().getId();var o=["Id","Name"];var c=e.getSource().getBindingContext("CostAssignmentsModel").getProperty("selectedCostObjectDesc");if(c!==""){var p="SalesOrders('"+c+"')/SalesOrderItems";this.createModel('OrderItems',p);if(this.getView().getModel("OrderItems")!==undefined){this.onValueHelpRequest(I,"TRC_LBL_SALES_ORDER_ITEM","/results","{ItemId}","{Description}","both",o,"OrderItems")}else{t._setBusyOn();jQuery.sap.delayedCall(1000,this,function(){t.onValueHelpRequest(I,"TRC_LBL_SALES_ORDER_ITEM","/results","{ItemId}","{Description}","both",o,"OrderItems");t._setBusyOff()})}}else{var C=I;C=C.replace("Trc_S_OrderItem","Trc_S_Type_Desc");this.byId(C).setValueState(sap.ui.core.ValueState.Error);this.byId(C).setValueStateText("Please Select Sales Order")}},onValueHelpRequest:function(f,t,p,d,a,o,b,m,c){var e=this.oResourceBundle.getText(t);var g=d;var h=b;var F=this.getView().byId(f);var n="";var O="";var j=function(E){var s=E.getParameter("selectedItem");if(s){if(o==="both"){n=s.getDescription()+" ("+s.getTitle()+")";O=F.getValue();F.setValue(n)}else{n=s.getTitle();O=F.getValue();F.setValue(n)}if(E.getId()==="confirm"){F.setValueState(sap.ui.core.ValueState.None);if(c&&O!==n){c(s.getTitle(),true)}}}E.getSource().getBinding("items").filter([])};var v=function(E){var V=E.getParameter("value");if(h instanceof Array){var k=[];for(var i=0;i<h.length;i++){var s=new sap.ui.model.Filter(h[i],sap.ui.model.FilterOperator.Contains,V);k.push(s)}var l=new sap.ui.model.Filter(k,false)}else{var l=new sap.ui.model.Filter(h,sap.ui.model.FilterOperator.Contains,V)}E.getSource().getBinding("items").filter([l])};this._valueHelpSelectDialog=new sap.m.SelectDialog({title:e,items:{path:p,template:new sap.m.StandardListItem({title:g,description:a,active:true})},search:v,liveChange:v,confirm:j,cancel:j});this._valueHelpSelectDialog.setModel(this.getView().getModel(m));this._valueHelpSelectDialog.open()},extractKey:function(v){if(v.indexOf("(")>0&&v.indexOf(")")>0){return v.substring(v.indexOf("(")+1,v.indexOf(")"))}else{return v}},onChangeCostDesc:function(e){},_onUpdateCostAssigment:function(e){var t=this;if(this.getView().getModel("CostAssignmentsModel")!==undefined){var c=this.getView().getModel("CostAssignmentsModel").getData();var p=e.getSource().getBindingContext("CostAssignmentsModel").sPath;var i=parseInt(p.substring(p.indexOf("/")+1,p.length));var s=e.getSource().getBindingContext("CostAssignmentsModel").getProperty("selectedCostObjectType");var C="";if(s==="CostCenter"){C=this.oResourceBundle.getText("TRC_COST_CENTER")}else if(s==="InternalOrder"){C=this.oResourceBundle.getText("TRC_INTERNAL_ORDER");if(this.getView().getModel("InternalOrders")===undefined){t.createModel('InternalOrders',"InternalOrders")}}else if(s==="Network"){C=this.oResourceBundle.getText("TRC_NETWORK");if(this.getView().getModel("Network")===undefined){t.createModel('Network',"Network")}}else if(s==="NetworkActivity"){C=this.oResourceBundle.getText("TRC_NETWORK_ACTIVITY");if(this.getView().getModel("NetworkActivity")===undefined){t.createModel('NetworkActivity',"NetworkActivity")}}else if(s==="Project"){C=this.oResourceBundle.getText("TRC_PROJECT");if(this.getView().getModel("Project")===undefined){t.createModel('Project',"Project")}}else if(s==="SalesOrderItem"){C=this.oResourceBundle.getText("TRC_SALES_ORDER_ITEM");if(this.getView().getModel("SalesOrderItem")===undefined){t.createModel('SalesOrderItem',"SalesOrderItem")}}else{C=this.oResourceBundle.getText("TRC_SALES_ORDER");if(this.getView().getModel("SalesOrders")===undefined){t.createModel('SalesOrders',"SalesOrders")}}if(i<c.length){c[i].selectedCostObjectDesc="";if(C=="Sales Order"){c[i].displaySelectedCostObjectField=true;c[i].selectedSalesOrderItem="";c[i].selectedSalesOrderItemDescription="";c[i].orderItemDisplayed=false}else{c[i].displaySelectedCostObjectField=false;c[i].selectedSalesOrderItem="";c[i].selectedSalesOrderItemDescription=""}c[i].selectedCostObjectType=e.getSource().getSelectedKey()}this.getView().getModel("CostAssignmentsModel").updateBindings()}},_onAddCostAssignment:function(e){var t=this;if(this.getView().getModel("CostAssignmentsModel")!==undefined){var c=this.getView().getModel("CostAssignmentsModel").getData();var a={"title":this.oResourceBundle.getText("TRC_LBL_COST_CENTER"),"counter":1,"percentage":100,"orderItemDisplayed":false,"selectedCostObject":"","displaySelectedCostObjectField":false,"selectedCostObjectDesc":"","selectedCostObjectType":"InternalOrder","removeDisplayed":true};c.push(a);if(this.getView().getModel("InternalOrders")===undefined){t.createModel('InternalOrders',"InternalOrders")}this.getView().getModel("CostAssignmentsModel").updateBindings()}},_onRemoveCostAssignment:function(e){if(this.getView().getModel("CostAssignmentsModel")!==undefined){var c=this.getView().getModel("CostAssignmentsModel").getData();var p=e.getSource().getBindingContext("CostAssignmentsModel").sPath;var i=parseInt(p.substring(p.indexOf("/")+1,p.length));c.splice(i,1);this.getView().getModel("CostAssignmentsModel").updateBindings()}},_handleSubmitTrc:function(e){var f=this.updateModelByForm(this.viewMode);if(f){if(this.viewMode==this.viewModes.NewTravel){this._handleCreateCall(e)}else if(this.viewMode==this.viewModes.EditTravel){this._handleUpdateCall(e)}}},updateModelByForm:function(v){if(!this.validateForm()){return false}var P=this.byId("Trc_I_Purpose").getValue();this.CreateTravelRequestModel.setProperty("/Purpose",P);var A=this.byId("Trc_s_Activity");this.CreateTravelRequestModel.setProperty("/TripActivity",A.getSelectedKey());var D=travel.request.create.util.Formatters.formatDateToISOString(new Date(this.byId("Trc_D_From").getDateValue()));this.CreateTravelRequestModel.setProperty("/Departure",D);var a=travel.request.create.util.Formatters.formatDateToISOString(new Date(this.byId("Trc_D_To").getDateValue()));this.CreateTravelRequestModel.setProperty("/Arrival",a);var c="";var C="";if(this.isPerDiemRegionsEnabled()){c=this.byId("Trc_SD_Country").getValue();C=this.getCodeFromFormattedValue(c);this.CreateTravelRequestModel.setProperty("/CountryCode",C);var f=this.byId("MB_FORM_PER_DIEM_REGION");if(f&&f.getVisible()){var p=this.byId("Trc_SD_PerDiemRegion").getValue();var s=this.getCodeFromFormattedValue(p);this.CreateTravelRequestModel.setProperty("/RegionCode",s)}}else{c=this.byId("Trc_SD_Destination").getValue();C=this.getCodeFromFormattedValue(c);this.CreateTravelRequestModel.setProperty("/CountryCode",C);this.CreateTravelRequestModel.setProperty("/RegionCode",undefined)}var L=this.byId("Trc_E_City").getValue();this.CreateTravelRequestModel.setProperty("/Location",L);var E=this.byId("Trc_E_Cost").getValue()||"0";this.CreateTravelRequestModel.setProperty("/EstimatedCost/Value",E);var b=this.byId("Trc_SC_Currency").getValue();this.CreateTravelRequestModel.setProperty("/EstimatedCost/Currency",b);var N=this.byId("Trc_L_Note").getValue();this.CreateTravelRequestModel.setProperty("/Note",N);var t=0;var O=[];if(this.getView().getModel("CostAssignmentsModel")!==undefined){var d=this.getView().getModel("CostAssignmentsModel").getData();if(v==this.viewModes.NewTravel){this.CreateTravelRequestModel.oData.CostAssignments=[]}for(var i=0;i<d.length;i++){if(v==this.viewModes.NewTravel){var e={};e.CostObjectId=this.extractKey(d[i].selectedCostObjectDesc);e.CostObjectType=d[i].selectedCostObjectType;e.Percentage=d[i].percentage.toString();if(d[i].selectedSalesOrderItem){e.CostObjectItemId=d[i].selectedSalesOrderItem}this.CreateTravelRequestModel.oData.CostAssignments.push(e);t=t+parseInt(d[i].percentage)}else if(v==this.viewModes.EditTravel){var e=[];e.push(this.extractKey(d[i].selectedCostObjectDesc));e.push(d[i].selectedCostObjectType);e.push(d[i].percentage.toString());e.push(d[i].selectedSalesOrderItem);O.push(e.join(","));t=t+parseInt(d[i].percentage)}}}if(v==this.viewModes.EditTravel){this.CreateTravelRequestModel.setProperty("/InlineCostAssignment",O.join(";"))}if(t!==100){this.showMessageBox(this.oResourceBundle.getText("ERR_PERCENTAGE"),sap.ca.ui.message.Type.ERROR);return false}var U=this.getUserInfo();if(U.GlobalSettings){if(!U.GlobalSettings.LateApproverDetermination&&U.Approver.length===0){this.showMessageBox(this.oResourceBundle.getText("ERR_MANAGER"),sap.ca.ui.message.Type.ERROR);return false}}else{if(U.Approver&&U.Approver.length===0){this.showMessageBox(this.oResourceBundle.getText("ERR_MANAGER"),sap.ca.ui.message.Type.ERROR);return false}}return true},validateForm:function(){var a=true;var c=this.byId("Trc_I_Purpose");c.setValue(c.getValue().trim());var v=c.getValue();if(v.length===0){a=false;c.setValueState(sap.ui.core.ValueState.Error)}else{c.setValueState(sap.ui.core.ValueState.None)}var C=this.byId("Trc_D_From");C.setValue(C.getValue().trim());var f=C.getDateValue();if(f.length==0){a=false;C.setValueState(sap.ui.core.ValueState.Error)}else{C.setValueState(sap.ui.core.ValueState.None)}var o=this.byId("Trc_D_To");o.setValue(o.getValue().trim());var t=o.getDateValue();if(t.length==0){a=false;o.setValueState(sap.ui.core.ValueState.Error)}else{o.setValueState(sap.ui.core.ValueState.None)}if(new Date(f)>new Date(t)){C.setValueState(sap.ui.core.ValueState.Error);o.setValueState(sap.ui.core.ValueState.Error);this.showMessageToast(this.oResourceBundle.getText("ERR_MSG_WRONG_DATE"));a=false}if(this.isPerDiemRegionsEnabled()){c=this.byId("Trc_SD_Country");c.setValue(c.getValue().trim());v=c.getValue();if(v.length===0||!v.match(".* \(.*\)")){a=false;c.setValueState(sap.ui.core.ValueState.Error)}else{if(c.getValueState()===sap.ui.core.ValueState.Error){a=false}}c=this.byId("Trc_SD_PerDiemRegion");if(c.getValueState()===sap.ui.core.ValueState.Error){a=false}}else{c=this.byId("Trc_SD_Destination");c.setValue(c.getValue().trim());v=c.getValue();if(v.length===0||!v.match(".* \(.*\)")){a=false;c.setValueState(sap.ui.core.ValueState.Error)}else{c.setValueState(sap.ui.core.ValueState.None)}}c=this.byId("Trc_E_Cost");c.setValue(c.getValue().trim());v=c.getValue()||"0";if(v.length===0||isNaN(+v)||v<0){a=false;c.setValueState(sap.ui.core.ValueState.Error)}else{c.setValueState(sap.ui.core.ValueState.None)}c=this.byId("Trc_SC_Currency");c.setValue(c.getValue().trim());v=c.getValue();c.setValueState(sap.ui.core.ValueState.None);if(v.length>0){c.setValueState(sap.ui.core.ValueState.None);var b=this.getView().getModel("Currencies").getData().results;var l=b.length,e=null;var d=false;for(var i=0;i<l;i++){e=b[i];if(e.Id==v){d=true}}if(!d){c.setValueState(sap.ui.core.ValueState.Error);a=false}}if(this.getView().getModel("CostAssignmentsModel")!==undefined){var g=this.getView().getModel("CostAssignmentsModel").getData();var h=0;var s=[];var _="-"+this.byId("oCostAssignment").getContent()[0].sId+"-";for(var i=0;i<g.length;i++){var j=g[i];var k=this.byId("Trc_S_Type_Desc").sId+_+i;this.byId(k).setValue(this.byId(k).getValue().trim());if(j.selectedCostObjectDesc.length===0){this.byId(k).setValueState(sap.ui.core.ValueState.Error);a=false}else{this.byId(k).setValueState(sap.ui.core.ValueState.None)}if(j.selectedCostObjectType==="SalesOrder"){k=this.byId("Trc_S_OrderItem").sId+_+i;this.byId(k).setValue(this.byId(k).getValue().trim());if(j.selectedSalesOrderItemDescription.length===0){this.byId(k).setValueState(sap.ui.core.ValueState.Error);a=false}else{this.byId(k).setValueState(sap.ui.core.ValueState.None)}}k=this.byId("Trc_I_Pct").sId+_+i;this.byId(k).setValue(this.byId(k).getValue().trim());s.push(this.byId(k));h=h+parseInt(j.percentage)}if(h!==100){for(var i=0;i<s.length;i++){s[i].setValueState(sap.ui.core.ValueState.Error);s[i].setValueStateText(this.oResourceBundle.getText("ERR_PERCENTAGE"))}a=false}else{for(var i=0;i<s.length;i++){s[i].setValueState(sap.ui.core.ValueState.NONE)}}}if(this.isPerDiemRegionsEnabled()){if(this.byId("Trc_SD_Country").getValueState===sap.ui.core.ValueState.Error){a=false}if(this.byId("Trc_SD_PerDiemRegion").getValueState===sap.ui.core.ValueState.Error){a=false}}return a},_handleCreateCall:function(e){var t=this;var U=this.getUserInfo();this.oDataModel.setRefreshAfterChange(false);this.oDataModel.create('/Travels',this.CreateTravelRequestModel.getData(),null,function(r){var c=sap.ui.core.Component.getOwnerIdFor(t.oView),C=sap.ui.component(c);var f=function(){t.oDataModel.detachRequestCompleted(f,t);this.oRouter.navTo("detail",{contextPath:"Travels('"+r.results.Id+"')"},true)};t.oDataModel.attachRequestCompleted(t,f,t);t.oDataModel.setRefreshAfterChange(true);t.oDataModel.refresh(true);t._setBusyOff();if(U.Approver){t.showMessageToast(t.oResourceBundle.getText("SUBMITTED_MSG",[U.Approver]))}else{t.showMessageToast(t.oResourceBundle.getText("SUBMITTED_MSG_NO_APPROVER"))}},function(E){t.oDataModel.setRefreshAfterChange(true);if(t.oDataModel.hasPendingChanges()){t.oDataModel.refresh(true)}t._onRequestFailed(E)})},_handleUpdateCall:function(e){var t=this;var v=this.getView();var U=this.getUserInfo();var d=v.getModel().getProperty(v.getBindingContext().getPath());t.oDataModel.setRefreshAfterChange(false);this._setBusyOn();var b;var B=[];var m=this.getView().getModel();m.clearBatch();b=m.createBatchOperation("/Travels('"+d.Id+"')","MERGE",this.CreateTravelRequestModel.getData(),null,null);B.push(b);m.addBatchChangeOperations(B);m.submitBatch(function(){var c=sap.ui.core.Component.getOwnerIdFor(t.oView),C=sap.ui.component(c);var f=function(){t.oDataModel.detachRequestCompleted(f,t);this.oRouter.navTo("detail",{contextPath:t.getView().getBindingContext().sPath.substr(1)},true)};t.oDataModel.attachRequestCompleted(t,f,t);t.oDataModel.setRefreshAfterChange(true);t.oDataModel.refresh(true);t._setBusyOff();if(U.Approver){t.showMessageToast(t.oResourceBundle.getText("SUBMITTED_MSG",[U.Approver]))}else{t.showMessageToast(t.oResourceBundle.getText("SUBMITTED_MSG_NO_APPROVER"))}},function(E){t._onRequestFailed(E)},true)},_handleNavBack:function(){if(this.viewMode===this.viewModes.NewTravel){window.history.back()}else if(this.viewMode===this.viewModes.EditTravel){this.oRouter.navTo("detail",{contextPath:this.getView().getBindingContext().sPath.substr(1)},true)}},_setBusyOn:function(){if(!this.busyOn){this.busyOn=true;sap.ca.ui.utils.busydialog.requireBusyDialog({text:this.oResourceBundle.getText("LOADING")})}},_setBusyOff:function(){if(this.busyOn){this.busyOn=false;sap.ca.ui.utils.busydialog.releaseBusyDialog()}},_onRequestFailed:function(e){this._setBusyOff();var a="";if(e!==null&&e.response!==null&&e.response.statusCode==412){a=this.oResourceBundle.getProperty("ERR_CONCURRENT_ACCESS")}else if(e!==null&&e.response!==null&&e.response.body!==null){var b=jQuery.parseJSON(e.response.body);a=b.error.message.value}else{a=this.oResourceBundle.getText("ERR_VALIDATION")}this.showMessageBox(a,sap.ca.ui.message.Type.ERROR)},showMessageBox:function(v,t){sap.ca.ui.message.showMessageBox({type:t,message:v});this._setBusyOff()},showMessageToast:function(v){sap.ca.ui.message.showMessageToast(v,{duration:3000})},getUserInfo:function(){if(this.getView().getModel("UserInfo"))var U=this.getView().getModel("UserInfo").getData();if(U.results){U=U.results;return U}else{return U}},checkGlobalSettingsTripActivity:function(){var U=this.getUserInfo();if(U.GlobalSettings){if(U.GlobalSettings.TripActivity){return true}else{return false}}else{return true}},checkGlobalSettingsFixedCurrency:function(){var U=this.getUserInfo();if(U.GlobalSettings){if(U.GlobalSettings.FixedCurrency){return true}else{return false}}else{return true}},createHeaderFooterOptions:function(){var t=this;return{sI18NDetailTitle:"DETAIL_TITLE",oEditBtn:{sI18nBtnTxt:"TRC_SUBMIT",onBtnPressed:jQuery.proxy(this._handleSubmitTrc,t)},buttonList:[{sId:"TRC_BTN_CANCEL",sI18nBtnTxt:"TRC_CANCEL",icon:"sap-icon://decline",onBtnPressed:jQuery.proxy(this._handleNavBack,t)}],oJamOptions:{},oAddBookmarkSettings:{title:t.oResourceBundle.getText("DISPLAY_NAME"),icon:"sap-icon://flight"},onBack:jQuery.proxy(function(){var d=sap.ui.core.routing.History.getInstance().getDirection("");if(d&&d!=="Unknown"){window.history.go(-1)}else{if(this.viewMode===t.viewModes.NewTravel){window.history.go(-1)}else{this.oRouter.navTo("detail",{contextPath:this.getView().getBindingContext().sPath.substr(1)},true)}}},this)}},isMainScreen:function(){return false}});
