/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("travel.request.create.util.Formatters");jQuery.sap.require("sap.ca.ui.dialog.factory");jQuery.sap.require("sap.m.MessageBox");sap.ca.scfld.md.controller.BaseDetailController.extend("travel.request.create.view.Detail",{onInit:function(){this.oResourceBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();var v=this.getView();this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="detail"){var a=e.getParameter("arguments").contextPath;jQuery.sap.delayedCall(0,this,function(C){this.getView().bindElement('/'+C)},[a]);if(this.byId("TabContainer").getSelectedKey()!=="Information"){this.byId("TabContainer").setSelectedKey("Information")}this.createModel('UserInfo',"UserInfo",null);if(this.isMultiCommentEnabled()){this.createModel('Notes',a+"/Notes",null,jQuery.proxy(this.handleNotes,this))}if(this.extHookOnDataRequest){this.extHookOnDataRequest(a)}}},this);var c=this.byId("TRC_COSTASSIGNMENTS_TABLE");if(c){c.addEventDelegate({onAfterRendering:this.updateCostAssignmentHeader},this)}},handleNotes:function(){if(this.getView().getModel("Notes")!==undefined){var n=new sap.m.FeedListItem({senderActive:true,showIcon:true,text:"{Content}",sender:"{AuthorName}",senderPress:jQuery.proxy(this._handlelinkToNoteAuthorPress,this),timestamp:"{path:'NoteDate', formatter:'travel.request.create.util.Formatters.formatDate'}",maxLines:3});var l=this.byId("notesList");l.bindAggregation("items",{path:"Notes",template:n});var m=this.byId("MultiNotesTab");m.setCount(this.getCommentCount());if(this.getCommentCount()<=0){m.setVisible(false)}else{m.setVisible(true)}}},createModel:function(m,p,f,P){var o=function(d,r){var M=new sap.ui.model.json.JSONModel(d);M.setSizeLimit(500);this.getView().setModel(M,m);this._setBusyOff();if(P){P()}};this._setBusyOn();this.oDataModel.read(p,null,f,true,jQuery.proxy(o,this),jQuery.proxy(this._onRequestFailed,this));return m},updateCostAssignmentHeader:function(e){this.updateHeaderText(e,"TRC_LBL_COST_CENTER_WITH_COUNT")},updateHeaderText:function(e,t){var s=e.srcControl;if(s){setTimeout(jQuery.proxy(function(){var i=s.getItems();var h=this.oResourceBundle.getText(t,[(i)?i.length:"0"]);s.setHeaderText(h)},this),300)}},_handlelinkToNoteAuthorPress:function(e){jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");var v=this.getView();var p=e.getSource().getBindingContext().getProperty("AuthorID");if(p){var c=e.getParameters().domRef;this.employeeModelReader(c,p)}},_handleApproverPress:function(){jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");var v=this.getView();if(this.getView().getModel("UserInfo")!==undefined){var U=this.getUserInfo();if(U.GlobalSettings&&U.GlobalSettings.LateApproverDetermination){var m=v.getModel();var b=v.getBindingContext();var A=m.getProperty("ApproverPersonalNumber",b);var e=A}else{e=U.ApproverPersonalNumber}var c=v.byId("EmpLink");this.employeeModelReader(c,e)}},_handleSenderPress:function(e){var t=this;jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");var v=this.getView();if(this.getView().getModel("UserInfo")!==undefined){var U=this.getUserInfo();var a=U.Id;var c=e.getParameters().domRef;t.employeeModelReader(c,a)}},employeeModelReader:function(c,e){var f=[];var i="$filter=Id eq '"+e+"'";f.push(i);this.oDataModel.read("Contacts",null,f,false,function(d){var E={title:d.results[0].Name,name:d.results[0].Name,imgurl:"",department:d.results[0].Department,contactmobile:d.results[0].Mobile,contactphone:d.results[0].Phone,contactemail:d.results[0].Email,contactemailsubj:"for you",companyname:d.results[0].Company,companyaddress:d.results[0].Address};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(c)},function(E){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:E.message,details:E.response.body})})},_handleEdit:function(){this.oRouter.navTo("edit",{contextPath:this.getView().getBindingContext().sPath.substr(1)},true)},_handleDelete:function(){var v=this.getView();var m=v.getModel();var b=v.getBindingContext();var o=m.getProperty("Purpose",b);var d=this.oResourceBundle.getText("CONFIRMATION_DELETE",[o]);sap.ca.ui.dialog.confirmation.open({question:d,showNote:false,title:this.oResourceBundle.getText("TRC_DELETE"),confirmButtonLabel:this.oResourceBundle.getText("TRC_DELETE")},jQuery.proxy(function(r){var D=m.getProperty(b.getPath());this._handleDeleteCall(r,D)},this))},_handleDeleteCall:function(r,d){var t=this;if(r.isConfirmed){var p={};p.fnSuccess=function(){var c=sap.ui.core.Component.getOwnerIdFor(t.oView),C=sap.ui.component(c);sap.ca.ui.message.showMessageToast(t.oResourceBundle.getText("DELETE_OK"));t.oDataModel.setRefreshAfterChange(true);t._setBusyOff();C.oEventBus.publish("travel.request.create","RefreshUpdateDelete",{param:"/Travels('"+d.Id+"')"});if(jQuery.device.is.phone){t._goBack()}};p.fnError=function(e){t.oDataModel.setRefreshAfterChange(true);if(t.oDataModel.hasPendingChanges()){t.oDataModel.refresh(true)}t._onRequestFailed(e)};this.oDataModel.setRefreshAfterChange(false);t._setBusyOn();this.oDataModel.remove("Travels('"+d.Id+"')",p)}},_setBusyOn:function(){if(!this.busyOn){this.busyOn=true;sap.ca.ui.utils.busydialog.requireBusyDialog({text:this.oResourceBundle.getText("LOADING")})}},_setBusyOff:function(){if(this.busyOn){this.busyOn=false;sap.ca.ui.utils.busydialog.releaseBusyDialog()}},_onRequestFailed:function(e){this._setBusyOff();sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.response.body})},getCommentCount:function(){if(this.getView().getModel("Notes"))var n=this.getView().getModel("Notes").getData();var c=0;if(n){for(var i=0;i<n.results.length;i++){c++}}return c},getUserInfo:function(){if(this.getView().getModel("UserInfo"))var U=this.getView().getModel("UserInfo").getData();if(U.results){U=U.results;return U}else{return U}},isMultiCommentEnabled:function(){var m=this.oApplicationFacade.getODataModel();var n=m.oMetadata._getEntityTypeName("Notes");if(n){return true}else{return false}},isSingleCommentEnabled:function(n){if(n&&!this.isMultiCommentEnabled()){return true}else{return false}},getHeaderFooterOptions:function(){var t=this;var A=new Array();A.push({sI18nBtnTxt:"TRC_DELETE",icon:"sap-icon://delete",onBtnPressed:jQuery.proxy(this._handleDelete,t),enabled:true});if(this.Additionalbuttons){A=A.concat(this.Additionalbuttons())}return{sI18NDetailTitle:"DETAIL_TITLE",oEditBtn:{sI18nBtnTxt:"TRC_EDIT",onBtnPressed:jQuery.proxy(this._handleEdit,t)},buttonList:A,oJamOptions:{},oAddBookmarkSettings:{title:t.oResourceBundle.getText("DISPLAY_NAME"),icon:"sap-icon://flight"},onBack:jQuery.proxy(this._goBack,this)}},isMainScreen:function(){return true},_goBack:function(){var d=sap.ui.core.routing.History.getInstance().getDirection("");if(d&&d!=="Unknown"){window.history.go(-1)}else{this.oRouter.navTo("master",{},true)}}});
